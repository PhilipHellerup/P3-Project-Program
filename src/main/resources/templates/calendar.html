<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jobs Calendar</title>

    <!-- Bootstrap CSS -->
    <link href="/css/bootstrap.css" rel="stylesheet"/>

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css" rel="stylesheet"/>

    <style>
      body { padding: 1.5rem; }
      .fc .fc-event { cursor: pointer; }
      .fc .fc-col-header-cell-cushion { color: #000; text-decoration: none; }
      .fc .fc-daygrid-day-number {color: #000; }
      .fc .fc-event-title {
        white-space: wrap;       /* keep on one line */
        overflow: hidden;          /* clip overflow */
        text-overflow: ellipsis;   /* show "..." when clipped */
        display: block;
      }

      /* Status palette */
      .status-notDelivered  { background-color: #f6c23e !important; border-color: #e0a800 !important; color: #000 !important; }
      .status-delivered     { background-color: #1cc88a !important; border-color: #17a673 !important; color: #fff !important; }
      .status-inProgress    { background-color: #4e73df !important; border-color: #2e59d9 !important; color: #fff !important; }
      .status-missingPart   { background-color: #f6b3b0 !important; border-color: #e07a78 !important; color: #000 !important; }
      .status-finished      { background-color: #858796 !important; border-color: #6c6c7a !important; color: #fff !important; }
      .status-pickedUp      { background-color: #8e44ad !important; border-color: #732d91 !important; color: #fff !important; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-0">Job Management Calendar</h1>
            <div class="legend mt-2">
                <span class="badge" style="background:#f6c23e;color:#000">Not Delivered</span>
                <span class="badge" style="background:#1cc88a;color:#000">Delivered</span>
                <span class="badge" style="background:#4e73df;color:#000">In Progress</span>
                <span class="badge" style="background:#f6b3b0;color:#000">Missing Part</span>
                <span class="badge" style="background:#858796;color:#000">Finished</span>
                <span class="badge" style="background:#8e44ad;color:#000">Picked Up</span>
            </div>
        </div>

        <div>
            <button class="btn btn-success" id="createJobBtn">Create Job</button>
            <a href="#" class="btn btn-primary" id="refreshBtn">Refresh</a>
        </div>
    </div>

    <div id="calendar"></div>

    <!-- View Job Modal -->
    <div class="modal fade" id="jobModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobModalTitle">Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="jobModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="editJobBtn">Edit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Job Modal -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="createJobForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="jobTitle" class="form-label">Title</label>
                        <input type="text" id="jobTitle" name="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Customer name</label>
                        <input type="text" id="customerName" name="customer_name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="customerPhone" class="form-label">Customer phone</label>
                        <input type="text" id="customerPhone" name="customer_phone" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="jobDescription" class="form-label">Job description</label>
                        <textarea id="jobDescription" name="job_description" class="form-control"></textarea>
                    </div>
                    <div class="mb-3 row">
                        <div class="col">
                            <label for="workTime" class="form-label">Work time (minutes)</label>
                            <input type="number" id="workTime" name="work_time_minutes" class="form-control" min="0" value="60">
                        </div>
                        <div class="col">
                            <label for="pricePerMin" class="form-label">Price per minute</label>
                            <input type="number" step="0.01" id="pricePerMin" name="price_per_minute" class="form-control" value="1.00">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="jobDate" class="form-label">Date / Start</label>
                        <input type="datetime-local" id="jobDate" name="date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="jobStatus" class="form-label">Status</label>
                        <select id="jobStatus" name="status_id" class="form-select" required>
                            <option value="1">Not Delivered</option>
                            <option value="2">Delivered</option>
                            <option value="3">In Progress</option>
                            <option value="4">Missing Part</option>
                            <option value="5">Finished</option>
                            <option value="6">Picked Up</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="editJobForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editJobId">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" id="editJobTitle" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" id="editCustomerName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Phone</label>
                        <input type="text" id="editCustomerPhone" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Job Description</label>
                        <textarea id="editJobDescription" class="form-control"></textarea>
                    </div>
                    <div class="mb-3 row">
                        <div class="col">
                            <label class="form-label">Work time (minutes)</label>
                            <input type="number" id="editWorkTime" class="form-control">
                        </div>
                        <div class="col">
                            <label class="form-label">Price per minute</label>
                            <input type="number" step="0.01" id="editPricePerMin" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date / Start</label>
                        <input type="datetime-local" id="editJobDate" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select id="editJobStatus" class="form-select">
                            <option value="1">Not Delivered</option>
                            <option value="2">Delivered</option>
                            <option value="3">In Progress</option>
                            <option value="4">Missing Part</option>
                            <option value="5">Finished</option>
                            <option value="6">PickedUp</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
<nav>
    <script src="/js/navbar.js"></script>
</nav>

<!-- Bootstrap JS (bundle includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

<script src="/js/html.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Map job to FullCalendar event ---
        function mapJobToEvent(job) {
            const statusName = job.status?.name || statusIdToName[job.status?.id] || 'notDelivered';
            const statusId = job.status?.id || statusNameToId[statusName] || 1;
            const colors = statusToColors(statusName);

            // Build the displayed title to include customer name
            const jobTitle = job.title || '';
            const customer = job.customer_name || '';
            // If both present: "Job Title — Customer Name"
            // If only customer present: "Customer Name"
            // If only title present: "Job Title"
            const displayTitle = (jobTitle && customer) ? `${jobTitle} — ${customer}`
                : (jobTitle ? jobTitle : (customer ? customer : 'Job'));

            return {
                id: job.id,
                title: displayTitle,
                start: job.date,
                end: job.date ? (new Date(job.date).getTime() + ((job.work_time_minutes || 0) * 60000)) : null,
                backgroundColor: colors.backgroundColor,
                borderColor: colors.borderColor,
                textColor: colors.textColor,
                classNames: [colors.cssClass],
                extendedProps: {
                    // keep original fields available for popover / edit modal
                    original_title: job.title || '',
                    customer_name: job.customer_name,
                    customer_phone: job.customer_phone,
                    job_description: job.job_description,
                    work_time_minutes: job.work_time_minutes,
                    price_per_minute: job.price_per_minute,
                    status: statusName,
                    status_id: statusId
                }
            };
        }

        // --- Fetch jobs and load into calendar ---
        function fetchJobsAndInit(calendar) {
            return fetch('/api/jobs')
                .then(r => r.json())
                .then(jobs => {
                    const events = jobs.map(mapJobToEvent);
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                });
        }

        // Format a Date object to local ISO WITHOUT timezone: "YYYY-MM-DDTHH:mm:ss"
        function formatLocalDateTime(date) {
            if (!date) return null;
            const pad = (n) => String(n).padStart(2, '0');
            const Y = date.getFullYear();
            const M = pad(date.getMonth() + 1);
            const D = pad(date.getDate());
            const hh = pad(date.getHours());
            const mm = pad(date.getMinutes());
            const ss = pad(date.getSeconds());
            return `${Y}-${M}-${D}T${hh}:${mm}:${ss}`;
        }

        // Build a full payload for PUT from an EventApi object (use existing values)
        function buildPayloadFromEvent(event) {
            // event.extendedProps holds fields we stored earlier (customer_name, etc.)
            const ep = event.extendedProps || {};
            // status_id stored in extendedProps
            const statusId = ep.status_id || 1;

            // Prefer the original raw title (stored in extendedProps.original_title).
            // Fall back to event.title only if original_title is missing.
            const rawTitle = (ep.original_title !== undefined && ep.original_title !== null && ep.original_title !== '')
                ? ep.original_title
                : (event.title || '');

            return {
                title: rawTitle,
                customer_name: ep.customer_name || '',
                customer_phone: ep.customer_phone || '',
                job_description: ep.job_description || '',
                work_time_minutes: ep.work_time_minutes || 0,
                price_per_minute: ep.price_per_minute || 0,
                // use local format used elsewhere
                date: event.start ? formatLocalDateTime(event.start) : null,
                status: { id: parseInt(statusId, 10) }
            };
        }

        // --- Calendar setup ---
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            navLinks: true,
            eventTimeFormat: { // like '14:30'
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },
            locale: 'da',
            buttonText: {
                today: 'I dag',
                month: 'Måned',
                week: 'Uge',
                day: 'Dag',
                list: 'Liste'
            },
            weekends: false,

            // ENABLE dragging & resizing
            editable: true, // allows events to be dragged/resized

            events: [],

            eventClick: function(info) {
                const job = info.event;
                const ep = job.extendedProps || {};

                let rawTitle = ep.original_title;
                if (!rawTitle) {
                    // Fallback: try to strip the appended " — Customer" from the displayed title
                    const displayed = job.title || '';
                    const cust = ep.customer_name || '';
                    if (cust && displayed.endsWith(' — ' + cust)) {
                        rawTitle = displayed.slice(0, displayed.length - (' — ' + cust).length);
                    } else if (displayed.includes(' — ')) {
                        rawTitle = displayed.split(' — ')[0];
                    } else {
                        rawTitle = displayed || 'Job';
                    }
                }

                let bodyHtml = `
                    <p><strong>Customer:</strong> ${escapeHtml(ep.customer_name || '')}</p>
                    <p><strong>Phone:</strong> ${escapeHtml(ep.customer_phone || '')}</p>
                    <p><strong>Description:</strong> ${escapeHtml(ep.job_description || '')}</p>
                    <p><strong>Work Time:</strong> ${escapeHtml(String(ep.work_time_minutes || 0))} min</p>
                    <p><strong>Price/Min:</strong> ${escapeHtml(String(ep.price_per_minute || 0))}</p>
                    <p><strong>Date:</strong> ${job.start ? escapeHtml(job.start.toLocaleString()) : ''}</p>
                    <p><strong>Status:</strong> ${escapeHtml(formatStatusName(ep.status))}</p>
                `;
                document.getElementById('jobModalTitle').innerText = rawTitle;
                document.getElementById('jobModalBody').innerHTML = bodyHtml;
                currentJob = job;
                jobModal.show();
            },

            // Fired when event is dropped (moved)
            eventDrop: function(info) {
                const ev = info.event;
                // Build payload from the event (with new start date/time)
                const payload = buildPayloadFromEvent(ev);

                // send update to backend
                fetch('/api/jobs/' + ev.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Server returned ' + response.status);
                        return response.json();
                    })
                    .then(updated => {
                        // Update event visuals & extendedProps with returned object
                        const newEvent = mapJobToEvent(updated);
                        ev.setProp('title', newEvent.title);
                        ev.setStart(newEvent.start);
                        ev.setEnd(newEvent.end);
                        ev.setProp('backgroundColor', newEvent.backgroundColor);
                        ev.setProp('borderColor', newEvent.borderColor);
                        ev.setProp('textColor', newEvent.textColor);
                        ev.setProp('classNames', newEvent.classNames);
                        for (const key in newEvent.extendedProps) {
                            ev.setExtendedProp(key, newEvent.extendedProps[key]);
                        }
                        // no further action needed; change persisted
                    })
                    .catch(err => {
                        console.error('Failed to update on drop:', err);
                        // revert visually to original position
                        info.revert();
                        alert('Could not move job — update failed (see console).');
                    });
            },

            // Fired when event is resized (duration changed)
            eventResize: function(info) {
                const ev = info.event;
                // Build payload from the event (with new start and end reflected by work_time_minutes maybe)
                // We'll update date (start) and keep work_time_minutes as original, but you might want to
                // recompute work_time_minutes from new duration: optional.
                // Here we'll keep same work_time_minutes and only update 'date' (start) on resize.
                const payload = buildPayloadFromEvent(ev);

                // Optionally recompute work_time_minutes from start->end:
                if (ev.start && ev.end) {
                    payload.work_time_minutes = Math.round((ev.end.getTime() - ev.start.getTime()) / 60000);
                }

                fetch('/api/jobs/' + ev.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Server returned ' + response.status);
                        return response.json();
                    })
                    .then(updated => {
                        const newEvent = mapJobToEvent(updated);
                        ev.setProp('title', newEvent.title);
                        ev.setStart(newEvent.start);
                        ev.setEnd(newEvent.end);
                        ev.setProp('backgroundColor', newEvent.backgroundColor);
                        ev.setProp('borderColor', newEvent.borderColor);
                        ev.setProp('textColor', newEvent.textColor);
                        ev.setProp('classNames', newEvent.classNames);
                        for (const key in newEvent.extendedProps) {
                            ev.setExtendedProp(key, newEvent.extendedProps[key]);
                        }
                    })
                    .catch(err => {
                        console.error('Failed to update on resize:', err);
                        info.revert();
                        alert('Could not resize job — update failed (see console).');
                    });
            },

            eventDidMount: function(info) {
                // Destroy any old popovers to avoid stacking
                if (info.el.dataset.bsToggle === 'popover') {
                    bootstrap.Popover.getInstance(info.el)?.dispose();
                }

                // Get job description (fallback if empty)
                const description = info.event.extendedProps.job_description || '(No description)';

                // Initialize a Bootstrap popover
                new bootstrap.Popover(info.el, {
                    title: "Description",
                    content: description,
                    trigger: 'hover',
                    placement: 'left',
                    container: 'body', // ensures it shows even if inside scrollable div
                    html: false
                });
            },
        });

        // --- Modals ---
        const jobModal = new bootstrap.Modal(document.getElementById('jobModal'));
        const createModal = new bootstrap.Modal(document.getElementById('createModal'));
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        let currentJob = null;

        calendar.render();
        fetchJobsAndInit(calendar);

        // --- Refresh ---
        document.getElementById('refreshBtn').addEventListener('click', e => {
            e.preventDefault();
            fetchJobsAndInit(calendar);
        });

        // --- Create job ---
        document.getElementById('createJobBtn').addEventListener('click', () => {
            document.getElementById('createJobForm').reset();
            createModal.show();
        });

        function toIsoLocalDateTime(localValue) {
            if (!localValue) return null;
            return localValue.length === 16 ? localValue + ':00' : localValue;
        }

        // Helper: format Date to local "yyyy-MM-ddTHH:mm" for datetime-local inputs
        function formatDateTimeLocal(date) {
            if (!date) return '';
            const pad = n => String(n).padStart(2, '0');
            const d = new Date(date);
            const yyyy = d.getFullYear();
            const MM = pad(d.getMonth() + 1);
            const dd = pad(d.getDate());
            const HH = pad(d.getHours());
            const mm = pad(d.getMinutes());
            return `${yyyy}-${MM}-${dd}T${HH}:${mm}`;
        }

        document.getElementById('createJobForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const payload = {
                title: document.getElementById('jobTitle').value,
                customer_name: document.getElementById('customerName').value,
                customer_phone: document.getElementById('customerPhone').value,
                job_description: document.getElementById('jobDescription').value,
                work_time_minutes: parseInt(document.getElementById('workTime').value || '0', 10),
                price_per_minute: parseFloat(document.getElementById('pricePerMin').value || '0'),
                date: toIsoLocalDateTime(document.getElementById('jobDate').value),
                status: { id: parseInt(document.getElementById('jobStatus').value, 10) }
            };

            fetch('/api/jobs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(created => {
                    calendar.addEvent(mapJobToEvent(created));
                    createModal.hide();
                })
                .catch(err => {
                    console.error(err);
                    alert('Failed to create job (see console)');
                });
        });

        // --- Open edit modal ---
        document.getElementById('editJobBtn').addEventListener('click', function() {
            if (!currentJob) return;
            document.getElementById('editJobId').value = currentJob.id;

            // Prefer the original raw title stored in extendedProps (set by mapJobToEvent).
            // If missing, try to remove the appended " — Customer Name" from the displayed title.
            const ep = currentJob.extendedProps || {};
            let originalTitle = ep.original_title;
            if (!originalTitle) {
                const displayed = currentJob.title || '';
                const cust = ep.customer_name || '';
                if (cust && displayed.endsWith(' — ' + cust)) {
                    originalTitle = displayed.slice(0, displayed.length - (' — ' + cust).length);
                } else if (displayed.includes(' — ')) {
                    originalTitle = displayed.split(' — ')[0];
                } else {
                    originalTitle = displayed;
                }
            }

            document.getElementById('editJobTitle').value = originalTitle || '';
            document.getElementById('editCustomerName').value = ep.customer_name || '';
            document.getElementById('editCustomerPhone').value = ep.customer_phone || '';
            document.getElementById('editJobDescription').value = ep.job_description || '';
            document.getElementById('editWorkTime').value = ep.work_time_minutes || 0;
            document.getElementById('editPricePerMin').value = ep.price_per_minute || 0;
            // Use local time for datetime-local input (avoid UTC shift)
            document.getElementById('editJobDate').value = formatDateTimeLocal(currentJob.start);
            document.getElementById('editJobStatus').value = ep.status_id || 1;

            jobModal.hide();
            editModal.show();
        });

        // --- Submit edit form ---
        document.getElementById('editJobForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const payload = {
                title: document.getElementById('editJobTitle').value,
                customer_name: document.getElementById('editCustomerName').value,
                customer_phone: document.getElementById('editCustomerPhone').value,
                job_description: document.getElementById('editJobDescription').value,
                work_time_minutes: parseInt(document.getElementById('editWorkTime').value || '0', 10),
                price_per_minute: parseFloat(document.getElementById('editPricePerMin').value || '0'),
                date: document.getElementById('editJobDate').value + ":00",
                status: { id: parseInt(document.getElementById('editJobStatus').value, 10) }
            };

            fetch('/api/jobs/' + document.getElementById('editJobId').value, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(updated => {
                    const newEvent = mapJobToEvent(updated);

                    // Update the currentJob FullCalendar Event API instance properly:
                    // setProp expects (name, value) for properties like 'title', 'backgroundColor', etc.
                    currentJob.setProp('title', newEvent.title);
                    // setStart and setEnd accept Date or ISO string
                    currentJob.setStart(newEvent.start);
                    currentJob.setEnd(newEvent.end);

                    currentJob.setProp('backgroundColor', newEvent.backgroundColor);
                    currentJob.setProp('borderColor', newEvent.borderColor);
                    currentJob.setProp('textColor', newEvent.textColor);

                    // classNames can be set with setProp('classNames', array)
                    currentJob.setProp('classNames', newEvent.classNames || []);

                    // Update extendedProps individually (so popover/modal still use correct fields)
                    for (const key in newEvent.extendedProps) {
                        currentJob.setExtendedProp(key, newEvent.extendedProps[key]);
                    }

                    editModal.hide();
                    // Refresh remote list to ensure server state and calendar are fully synced
                    fetchJobsAndInit(calendar);
                })
                .catch(err => {
                    console.error(err);
                    alert('Failed to update job');
                });
        });

    });
</script>
</body>
</html>
